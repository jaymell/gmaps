# to see country data:
from flask import Flask
from flask import render_template
from pymongo import MongoClient
from bson import json_util
from bson.json_util import dumps
import json
import pycountry


app = Flask(__name__)

MONGODB_HOST = 'localhost'
MONGODB_PORT = 27017
DB_NAME = 'top_sites'
COLLECTION_NAME = 'sites'
connection = MongoClient(MONGODB_HOST, MONGODB_PORT)
collection = connection[DB_NAME][COLLECTION_NAME]

@app.route("/")
def index():
        return render_template("index.html")

@app.route("/json")
def get_json():
        sites = [ i for i in collection.find({}, {'_id': False}) ]
        sites = json.dumps(sites, default=json_util.default)
        return sites

@app.route("/test")
def test():
        return render_template("test.html")

a = json.loads(get_json())
codes = []
for site_dict in a:
	for site, data in site_dict.items():
		for ip, ip_data in data.items():
			try:
				# make uppercase:
				two_letter = ip_data['address'].split()[-1].upper()
			except Exception as e:
				print('FAILED: ',e,ip_data['address'])
			else:
				country = pycountry.countries.get(alpha2=two_letter)
				three_letter = country.alpha3
				print('THREE LETTER! %s' % three_letter)

				#codes.append(ip_data['address'].split()[-1])


	
